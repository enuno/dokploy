services:
  # =============================================================================
  # Kestra - Event-Driven Orchestration Platform
  # Declarative workflow automation with 400+ plugin integrations
  # =============================================================================
  kestra:
    image: kestra/kestra:v0.19.14
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Persist workflow data, executions, and internal storage
      - kestra-data:/app/storage

      # Docker socket access for Docker task execution
      # Required for workflows that run Docker containers
      - /var/run/docker.sock:/var/run/docker.sock

      # Task working directory for temporary files
      - /tmp/kestra-wd:/tmp/kestra-wd
    environment:
      # =======================================================================
      # Kestra Configuration (YAML format)
      # =======================================================================
      KESTRA_CONFIGURATION: |
        # Database configuration (PostgreSQL backend)
        datasources:
          postgres:
            url: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-kestra}
            driverClassName: org.postgresql.Driver
            username: ${POSTGRES_USER:-kestra}
            password: ${POSTGRES_PASSWORD:?Set database password}

        # Kestra internal configuration
        kestra:
          # Use PostgreSQL for repository (workflows, templates, metadata)
          repository:
            type: postgres

          # Use PostgreSQL for queue (task execution queue)
          queue:
            type: postgres

          # Local storage configuration
          storage:
            type: local
            local:
              base-path: /app/storage

          # Server configuration
          server:
            # Basic authentication (optional - can use Kestra's built-in user management)
            basic-auth:
              enabled: ${KESTRA_BASIC_AUTH_ENABLED:-false}
              username: ${KESTRA_ADMIN_USER:-}
              password: ${KESTRA_ADMIN_PASSWORD:-}

          # Public URL for webhook callbacks and UI links
          url: https://${KESTRA_DOMAIN}/

          # Task working directory
          tasks:
            tmp-dir:
              path: /tmp/kestra-wd/tmp
    networks:
      - kestra-net
      - dokploy-network
    labels:
      # =======================================================================
      # Traefik Routing Configuration
      # =======================================================================
      - "traefik.enable=true"
      - "traefik.http.routers.kestra.rule=Host(`${KESTRA_DOMAIN}`)"
      - "traefik.http.routers.kestra.entrypoints=websecure"
      - "traefik.http.routers.kestra.tls.certresolver=letsencrypt"

      # Security headers middleware
      - "traefik.http.routers.kestra.middlewares=kestra-security-headers@docker"
      - "traefik.http.middlewares.kestra-security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.kestra-security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.kestra-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.kestra-security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.kestra-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.kestra-security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"

      # Service configuration
      - "traefik.http.services.kestra.loadbalancer.server.port=8080"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G

  # =============================================================================
  # PostgreSQL - Database Backend
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-kestra}
      POSTGRES_USER: ${POSTGRES_USER:-kestra}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set database password}
    networks:
      - kestra-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-kestra} -d ${POSTGRES_DB:-kestra}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  kestra-data:
    driver: local
  postgres-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  kestra-net:
    driver: bridge
  dokploy-network:
    external: true
