services:
  # =============================================================================
  # Opengist - Self-hosted Git-backed pastebin
  # GitHub Gist alternative with private/public gists
  # =============================================================================
  opengist:
    image: ghcr.io/thomiceli/opengist:1.11
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Persist Git repositories and gist data
      - opengist-data:/opengist
    environment:
      # =======================================================================
      # Database Configuration (PostgreSQL)
      # =======================================================================
      OG_DB_URI: postgres://opengist:${POSTGRES_PASSWORD:?Set database password}@postgres:5432/opengist?sslmode=disable

      # =======================================================================
      # Instance Configuration
      # =======================================================================
      OG_EXTERNAL_URL: https://${OPENGIST_DOMAIN:?Set your domain (e.g., gist.example.com)}
      OG_OPENGIST_HOME: /opengist

      # =======================================================================
      # Security
      # =======================================================================
      OG_SECRET_KEY: ${OG_SECRET_KEY:?Set secret key for sessions}

      # =======================================================================
      # SSH Git Access (optional but enabled by default)
      # =======================================================================
      OG_SSH_GIT_ENABLED: ${OG_SSH_ENABLED:-true}
      OG_SSH_PORT: "2222"
      OG_SSH_EXTERNAL_DOMAIN: ${OPENGIST_DOMAIN}

      # =======================================================================
      # HTTP Configuration
      # =======================================================================
      OG_HTTP_PORT: "6157"

      # =======================================================================
      # Logging
      # =======================================================================
      OG_LOG_LEVEL: ${OG_LOG_LEVEL:-warn}
    networks:
      - opengist-net
      - dokploy-network
    labels:
      # =======================================================================
      # Traefik Routing Configuration
      # =======================================================================
      - "traefik.enable=true"
      - "traefik.http.routers.opengist.rule=Host(`${OPENGIST_DOMAIN}`)"
      - "traefik.http.routers.opengist.entrypoints=websecure"
      - "traefik.http.routers.opengist.tls.certresolver=letsencrypt"

      # Security headers middleware
      - "traefik.http.routers.opengist.middlewares=opengist-security-headers@docker"
      - "traefik.http.middlewares.opengist-security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.opengist-security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.opengist-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.opengist-security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.opengist-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.opengist-security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"

      # Service configuration
      - "traefik.http.services.opengist.loadbalancer.server.port=6157"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6157/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # PostgreSQL - Database Backend
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: opengist
      POSTGRES_USER: opengist
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set database password}
    networks:
      - opengist-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U opengist -d opengist"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# =============================================================================
# Volumes
# =============================================================================
volumes:
  opengist-data:
    driver: local
  postgres-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  opengist-net:
    driver: bridge
  dokploy-network:
    external: true
