services:
  # =============================================================================
  # WoT Relay - Web of Trust Nostr Relay
  # Archives every note from your trust network
  # =============================================================================
  wot-relay:
    build:
      context: .
      dockerfile: Dockerfile
    image: wot-relay:${WOT_VERSION:-v0.1.18}
    restart: always
    volumes:
      - wot-data:/app/db
    environment:
      # =======================================================================
      # Core Configuration
      # =======================================================================
      RELAY_NAME: ${RELAY_NAME:-WoT Relay}
      RELAY_DESCRIPTION: ${RELAY_DESCRIPTION:-Web of Trust Nostr Relay}
      RELAY_PUBKEY: ${RELAY_PUBKEY:?Set owner hex pubkey (not npub)}
      RELAY_ICON: ${RELAY_ICON:-}
      RELAY_CONTACT: ${RELAY_CONTACT:-}

      # Domain for WebSocket URL
      RELAY_URL: wss://${WOT_DOMAIN:?Set WoT Relay domain}

      # =======================================================================
      # Database & Paths
      # =======================================================================
      DB_PATH: /app/db
      INDEX_PATH: /app/templates/index.html
      STATIC_PATH: /app/static

      # =======================================================================
      # Web of Trust Settings
      # =======================================================================
      # How often to refresh the trust network (hours)
      REFRESH_INTERVAL_HOURS: ${REFRESH_INTERVAL_HOURS:-24}

      # Minimum followers to be included in WoT
      MINIMUM_FOLLOWERS: ${MINIMUM_FOLLOWERS:-3}

      # Pubkeys to exclude from WoT (comma-separated hex keys)
      IGNORE_FOLLOWS_LIST: ${IGNORE_FOLLOWS_LIST:-}

      # =======================================================================
      # Archival Settings (use with caution - increases storage)
      # =======================================================================
      # Archive all notes from WoT members (not just recent)
      ARCHIVAL_SYNC: ${ARCHIVAL_SYNC:-FALSE}

      # Archive all reactions from WoT members
      ARCHIVE_REACTIONS: ${ARCHIVE_REACTIONS:-FALSE}

    networks:
      - wot-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wot-relay.rule=Host(`${WOT_DOMAIN}`)"
      - "traefik.http.routers.wot-relay.entrypoints=websecure"
      - "traefik.http.routers.wot-relay.tls.certresolver=letsencrypt"
      - "traefik.http.services.wot-relay.loadbalancer.server.port=3334"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3334"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G

# =============================================================================
# Volumes
# =============================================================================
volumes:
  wot-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  wot-net:
    driver: bridge
  dokploy-network:
    external: true
