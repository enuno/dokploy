services:
  # =============================================================================
  # n8n - Workflow Automation Platform
  # Self-hosted alternative to Zapier/Make with 400+ integrations
  # =============================================================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:2.1.4
    restart: always
    volumes:
      # Persist workflow data, credentials, and settings
      - n8n-data:/home/node/.n8n
    environment:
      # =======================================================================
      # Instance Configuration
      # =======================================================================
      # Listen on all interfaces (required for Traefik proxy)
      N8N_LISTEN_ADDRESS: "0.0.0.0"

      # Public URL for webhooks and OAuth callbacks
      N8N_HOST: ${N8N_DOMAIN:?Set n8n domain}
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://${N8N_DOMAIN}/

      # Editor URL (same as public URL for single-instance setup)
      N8N_EDITOR_BASE_URL: https://${N8N_DOMAIN}/

      # =======================================================================
      # Database Configuration (PostgreSQL)
      # =======================================================================
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-n8n}
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:?Set database password}

      # =======================================================================
      # Security Configuration
      # =======================================================================
      # Encryption key for credentials (generate with: openssl rand -hex 32)
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:?Set encryption key}

      # Basic auth for editor (optional - can use n8n's built-in user management)
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-false}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-}

      # =======================================================================
      # Timezone Configuration
      # =======================================================================
      GENERIC_TIMEZONE: ${TZ:-UTC}
      TZ: ${TZ:-UTC}

      # =======================================================================
      # Performance Configuration
      # =======================================================================
      # Enable task runners for better workflow execution (n8n 2.0+)
      N8N_RUNNERS_ENABLED: ${N8N_RUNNERS_ENABLED:-true}
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN:?Set task runner auth token}
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0

      # Execution settings
      EXECUTIONS_DATA_PRUNE: ${EXECUTIONS_DATA_PRUNE:-true}
      EXECUTIONS_DATA_MAX_AGE: ${EXECUTIONS_DATA_MAX_AGE:-336}

      # =======================================================================
      # Optional: SMTP Configuration for Email Notifications
      # =======================================================================
      N8N_EMAIL_MODE: ${N8N_EMAIL_MODE:-smtp}
      N8N_SMTP_HOST: ${N8N_SMTP_HOST:-}
      N8N_SMTP_PORT: ${N8N_SMTP_PORT:-587}
      N8N_SMTP_USER: ${N8N_SMTP_USER:-}
      N8N_SMTP_PASS: ${N8N_SMTP_PASS:-}
      N8N_SMTP_SENDER: ${N8N_SMTP_SENDER:-}
      N8N_SMTP_SSL: ${N8N_SMTP_SSL:-true}

      # =======================================================================
      # Optional: External Storage (Cloudflare R2)
      # =======================================================================
      # Enable S3-compatible storage for binary data (file uploads, etc.)
      # Requires Enterprise license or self-hosted deployment
      N8N_AVAILABLE_BINARY_DATA_MODES: ${N8N_AVAILABLE_BINARY_DATA_MODES:-filesystem}
      N8N_DEFAULT_BINARY_DATA_MODE: ${N8N_DEFAULT_BINARY_DATA_MODE:-filesystem}

      # Cloudflare R2 Configuration (S3-compatible)
      # R2 endpoint format: https://<account_id>.r2.cloudflarestorage.com
      N8N_EXTERNAL_STORAGE_S3_HOST: ${N8N_EXTERNAL_STORAGE_S3_HOST:-}
      N8N_EXTERNAL_STORAGE_S3_BUCKET_NAME: ${N8N_EXTERNAL_STORAGE_S3_BUCKET_NAME:-}
      N8N_EXTERNAL_STORAGE_S3_BUCKET_REGION: ${N8N_EXTERNAL_STORAGE_S3_BUCKET_REGION:-auto}
      N8N_EXTERNAL_STORAGE_S3_ACCESS_KEY: ${N8N_EXTERNAL_STORAGE_S3_ACCESS_KEY:-}
      N8N_EXTERNAL_STORAGE_S3_ACCESS_SECRET: ${N8N_EXTERNAL_STORAGE_S3_ACCESS_SECRET:-}

    networks:
      - n8n-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${N8N_DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G

  # =============================================================================
  # PostgreSQL - Database Backend
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-n8n}
      POSTGRES_USER: ${POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set database password}
    networks:
      - n8n-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-n8n} -d ${POSTGRES_DB:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M

  # =============================================================================
  # Task Runners - Execute Code Nodes in Isolated Environment
  # =============================================================================
  n8n-task-runner:
    image: n8nio/runners:2.1.4
    restart: always
    environment:
      # Authentication token (must match n8n's token)
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN:?Set task runner auth token}

      # Task broker connection
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n:5679

      # Auto-shutdown when idle (seconds)
      N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT: ${N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT:-15}

      # Timezone (should match n8n's timezone)
      TZ: ${TZ:-UTC}
    networks:
      - n8n-net
    depends_on:
      - n8n
    deploy:
      resources:
        limits:
          memory: 512M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  n8n-data:
    driver: local
  postgres-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  n8n-net:
    driver: bridge
  dokploy-network:
    external: true
