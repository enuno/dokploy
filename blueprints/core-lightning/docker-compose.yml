services:
  lightningd:
    image: elementsproject/lightningd:v25.12
    restart: always
    depends_on:
      bitcoind:
        condition: service_healthy
    volumes:
      - lightning-data:/root/.lightning
    environment:
      # ===========================================
      # Network Configuration
      # ===========================================
      LIGHTNING_NETWORK: ${LIGHTNING_NETWORK:-bitcoin}

      # ===========================================
      # Bitcoin Backend Configuration
      # ===========================================
      BITCOIN_RPC_USER: ${BITCOIN_RPC_USER:-bitcoin}
      BITCOIN_RPC_PASSWORD: ${BITCOIN_RPC_PASSWORD:?Set Bitcoin RPC password}

      # ===========================================
      # Node Identity
      # ===========================================
      LIGHTNING_ALIAS: ${LIGHTNING_ALIAS:-MyCoreLightningNode}
      LIGHTNING_RGB_COLOR: ${LIGHTNING_RGB_COLOR:-3399FF}
    command:
      - --network=${LIGHTNING_NETWORK:-bitcoin}
      - --bitcoin-rpcconnect=bitcoind
      - --bitcoin-rpcport=8332
      - --bitcoin-rpcuser=${BITCOIN_RPC_USER:-bitcoin}
      - --bitcoin-rpcpassword=${BITCOIN_RPC_PASSWORD}
      - --bitcoin-zmqpubrawblock=tcp://bitcoind:28332
      - --bitcoin-zmqpubrawtx=tcp://bitcoind:28333
      - --alias=${LIGHTNING_ALIAS:-MyCoreLightningNode}
      - --rgb=${LIGHTNING_RGB_COLOR:-3399FF}
      - --bind-addr=0.0.0.0:9735
      - --announce-addr=${LIGHTNING_ANNOUNCE_ADDR}:${LIGHTNING_P2P_PORT:-9735}
      - --log-level=${LIGHTNING_LOG_LEVEL:-info}
    networks:
      - core-lightning-net
      - dokploy-network
    ports:
      - "${LIGHTNING_P2P_PORT:-9735}:9735"  # Lightning P2P network
    healthcheck:
      test: ["CMD-SHELL", "lightning-cli --network=${LIGHTNING_NETWORK:-bitcoin} getinfo > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  bitcoind:
    image: ruimarinho/bitcoin-core:27.0
    restart: always
    command:
      - -printtoconsole
      - -rpcallowip=0.0.0.0/0
      - -rpcbind=0.0.0.0
      - -server=1
      - -txindex=0
      - -prune=${BITCOIN_PRUNE:-10000}
      - -zmqpubrawblock=tcp://0.0.0.0:28332
      - -zmqpubrawtx=tcp://0.0.0.0:28333
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
    environment:
      # ===========================================
      # Bitcoin Core Configuration
      # ===========================================
      BITCOIN_DATA: /home/bitcoin/.bitcoin

      # ===========================================
      # RPC Configuration (for Lightning backend)
      # ===========================================
      BITCOIN_RPC_USER: ${BITCOIN_RPC_USER:-bitcoin}
      BITCOIN_RPC_PASSWORD: ${BITCOIN_RPC_PASSWORD:?Set Bitcoin RPC password}
    networks:
      - core-lightning-net
    healthcheck:
      test: ["CMD-SHELL", "bitcoin-cli -rpcuser=${BITCOIN_RPC_USER:-bitcoin} -rpcpassword=${BITCOIN_RPC_PASSWORD} getblockchaininfo > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  lightning-data:
    driver: local
  bitcoin-data:
    driver: local

networks:
  core-lightning-net:
    driver: bridge
  dokploy-network:
    external: true
