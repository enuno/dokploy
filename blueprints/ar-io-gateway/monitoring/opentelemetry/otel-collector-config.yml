# OpenTelemetry Collector Configuration for AR.IO Gateway
#
# This configuration receives traces from AR.IO Core and exports them to:
# - Console (for debugging)
# - Prometheus (for metrics)
# - Optional backend (Jaeger, Tempo, Honeycomb, etc.)
#
# Documentation: https://opentelemetry.io/docs/collector/configuration/

receivers:
  # OTLP receiver for traces, metrics, and logs
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "*"

  # Prometheus receiver (scrapes metrics)
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 10s
          static_configs:
            - targets: ['localhost:8888']

processors:
  # Batch processor - improves performance
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Memory limiter - prevents OOM
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Resource processor - adds resource attributes
  resource:
    attributes:
      - key: service.namespace
        value: ar-io-gateway
        action: upsert
      - key: deployment.environment
        value: ${ENVIRONMENT:-production}
        action: upsert

  # Tail sampling - reduces trace volume intelligently
  # Keep all error traces, sample 10% of successful traces
  tail_sampling:
    decision_wait: 10s
    num_traces: 10000
    expected_new_traces_per_sec: 100
    policies:
      # Always sample errors
      - name: errors
        type: status_code
        status_code:
          status_codes:
            - ERROR
      # Sample 10% of successful traces
      - name: probabilistic
        type: probabilistic
        probabilistic:
          sampling_percentage: 10

exporters:
  # Console exporter for debugging (can be disabled in production)
  logging:
    loglevel: ${OTEL_LOG_LEVEL:-info}
    sampling_initial: 5
    sampling_thereafter: 200

  # Prometheus exporter - exposes metrics for Prometheus to scrape
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: otel
    const_labels:
      service: ar-io-gateway

  # OTLP exporter to backend (Jaeger, Tempo, Honeycomb, etc.)
  # Uncomment and configure based on your backend
  otlp:
    endpoint: ${OTEL_BACKEND_ENDPOINT:-}
    headers:
      api-key: ${OTEL_BACKEND_API_KEY:-}
    compression: gzip
    timeout: 30s

  # Example: Jaeger exporter
  # jaeger:
  #   endpoint: jaeger:14250
  #   tls:
  #     insecure: true

  # Example: Tempo exporter (via OTLP)
  # otlp/tempo:
  #   endpoint: tempo:4317
  #   tls:
  #     insecure: true

  # Example: Honeycomb exporter
  # otlp/honeycomb:
  #   endpoint: api.honeycomb.io:443
  #   headers:
  #     x-honeycomb-team: ${HONEYCOMB_API_KEY}

extensions:
  # Health check extension
  health_check:
    endpoint: :13133

  # Performance profiling extension
  pprof:
    endpoint: :1777

  # zPages extension for debugging
  zpages:
    endpoint: :55679

service:
  extensions: [health_check, pprof, zpages]

  pipelines:
    # Traces pipeline
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, tail_sampling, batch]
      exporters: [logging, otlp]

    # Metrics pipeline
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, resource, batch]
      exporters: [logging, prometheus]

    # Logs pipeline (optional)
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [logging]

  # Telemetry configuration
  telemetry:
    logs:
      level: ${OTEL_LOG_LEVEL:-info}
    metrics:
      address: :8888
      level: detailed
