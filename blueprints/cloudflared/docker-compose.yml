services:
  # =============================================================================
  # Cloudflared - Cloudflare Tunnel Client
  # Secure outbound tunnel to Cloudflare network (no exposed ports needed)
  # =============================================================================
  cloudflared:
    image: cloudflare/cloudflared:2025.11.1
    restart: always
    environment:
      # =======================================================================
      # Tunnel Token (from Cloudflare Zero Trust Dashboard)
      # =======================================================================
      # Get token from: Zero Trust → Networks → Tunnels → Create Tunnel
      # The token contains all routing configuration
      TUNNEL_TOKEN: ${TUNNEL_TOKEN:?Set tunnel token from Cloudflare dashboard}

      # =======================================================================
      # Optional Settings
      # =======================================================================
      # Timezone for logging
      TZ: ${TZ:-UTC}

    command: tunnel --no-autoupdate run
    networks:
      - cloudflared-net
      - dokploy-network
    # No Traefik labels - cloudflared IS the ingress, not behind Traefik
    # No ports exposed - tunnel connects outbound to Cloudflare
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 128M

# =============================================================================
# Networks
# =============================================================================
networks:
  cloudflared-net:
    driver: bridge
  dokploy-network:
    external: true
