services:
  browserless:
    image: ghcr.io/browserless/chromium:v2.26.0
    restart: always
    volumes:
      - browserless-downloads:/downloads
    environment:
      # Required authentication token
      TOKEN: ${TOKEN:?Set a secure authentication token for API access}

      # Concurrency configuration
      CONCURRENT: ${CONCURRENT:-10}
      MAX_QUEUE_LENGTH: ${MAX_QUEUE_LENGTH:-100}
      TIMEOUT: ${TIMEOUT:-30000}

      # Pre-boot optimization
      PREBOOT_CHROME: ${PREBOOT_CHROME:-true}

      # Cloudflare R2 Storage (Optional - for artifact storage)
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_REGION: ${S3_REGION:-auto}
      S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-true}
    networks:
      - browserless-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.browserless.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.browserless.entrypoints=websecure"
      - "traefik.http.routers.browserless.tls.certresolver=letsencrypt"
      - "traefik.http.services.browserless.loadbalancer.server.port=3000"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  browserless-downloads:
    driver: local

networks:
  browserless-net:
    driver: bridge
  dokploy-network:
    external: true
