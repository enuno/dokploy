version: "3.8"

services:
  # =============================================================================
  # Grafana - Visualization Dashboard
  # =============================================================================
  grafana:
    image: grafana/grafana:11.4.0
    restart: always
    depends_on:
      influxdb:
        condition: service_healthy
      mimir:
        condition: service_healthy
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      # Domain Configuration
      GF_SERVER_ROOT_URL: https://${GRAFANA_DOMAIN:?Set Grafana domain}
      GF_SERVER_DOMAIN: ${GRAFANA_DOMAIN:?Set Grafana domain}

      # Security
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?Set Grafana admin password}
      GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY:?Set Grafana secret key}

      # Database (SQLite by default, embedded)
      GF_DATABASE_TYPE: sqlite3

      # InfluxDB Datasource (provisioned via env)
      GF_DATASOURCES_INFLUXDB_URL: http://influxdb:8086
      GF_DATASOURCES_INFLUXDB_TOKEN: ${INFLUXDB_ADMIN_TOKEN:?Set InfluxDB admin token}
      GF_DATASOURCES_INFLUXDB_ORG: ${INFLUXDB_ORG:-homelab}
      GF_DATASOURCES_INFLUXDB_BUCKET: ${INFLUXDB_BUCKET:-metrics}

      # Mimir Datasource
      GF_DATASOURCES_MIMIR_URL: http://mimir:9009/prometheus

      # Anonymous Access (disabled by default)
      GF_AUTH_ANONYMOUS_ENABLED: ${GRAFANA_ANONYMOUS_ENABLED:-false}

      # Plugins
      GF_INSTALL_PLUGINS: ${GRAFANA_PLUGINS:-grafana-clock-panel,grafana-piechart-panel}

      # Performance
      GF_RENDERING_CALLBACK_URL: https://${GRAFANA_DOMAIN}

    networks:
      - observability-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`${GRAFANA_DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # InfluxDB - High-Throughput Time Series Database
  # =============================================================================
  influxdb:
    image: influxdb:2.7-alpine
    restart: always
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    environment:
      # Initial Setup
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_ADMIN_USER:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD:?Set InfluxDB admin password}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG:-homelab}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET:-metrics}
      DOCKER_INFLUXDB_INIT_RETENTION: ${INFLUXDB_RETENTION:-30d}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_ADMIN_TOKEN:?Set InfluxDB admin token}

      # Performance Tuning
      INFLUXD_STORAGE_CACHE_MAX_MEMORY_SIZE: ${INFLUXDB_CACHE_SIZE:-1073741824}
      INFLUXD_STORAGE_CACHE_SNAPSHOT_MEMORY_SIZE: ${INFLUXDB_SNAPSHOT_SIZE:-26214400}
    networks:
      - observability-net
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Grafana Mimir - Long-Term Metrics Storage (Prometheus Compatible)
  # =============================================================================
  mimir:
    image: grafana/mimir:2.14.1
    restart: always
    command:
      - "-config.file=/etc/mimir/mimir.yaml"
      - "-target=all"
    volumes:
      - mimir-data:/data
    environment:
      # Multi-tenancy (optional)
      MIMIR_TENANT_ID: ${MIMIR_TENANT_ID:-anonymous}

      # S3-Compatible Storage (Cloudflare R2)
      MIMIR_S3_ENDPOINT: ${MIMIR_S3_ENDPOINT:-}
      MIMIR_S3_ACCESS_KEY_ID: ${MIMIR_S3_ACCESS_KEY_ID:-}
      MIMIR_S3_SECRET_ACCESS_KEY: ${MIMIR_S3_SECRET_ACCESS_KEY:-}
      MIMIR_S3_BUCKET: ${MIMIR_S3_BUCKET:-mimir-blocks}
    configs:
      - source: mimir-config
        target: /etc/mimir/mimir.yaml
    networks:
      - observability-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9009/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # Prometheus - Metrics Scraper and Remote Write
  # =============================================================================
  prometheus:
    image: prom/prometheus:v2.55.0
    restart: always
    depends_on:
      mimir:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}"
      - "--web.enable-lifecycle"
      - "--web.enable-remote-write-receiver"
    volumes:
      - prometheus-data:/prometheus
    configs:
      - source: prometheus-config
        target: /etc/prometheus/prometheus.yml
    environment:
      # Used in config template
      PROMETHEUS_SCRAPE_INTERVAL: ${PROMETHEUS_SCRAPE_INTERVAL:-15s}
    networks:
      - observability-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Node Exporter - System Metrics
  # =============================================================================
  node-exporter:
    image: prom/node-exporter:v1.8.2
    restart: always
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - observability-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # Promtail - Log Shipping to Grafana Cloud Loki
  # =============================================================================
  promtail:
    image: grafana/promtail:3.2.0
    restart: always
    command:
      - "-config.file=/etc/promtail/promtail.yaml"
    volumes:
      - /var/log:/var/log:ro
      - promtail-positions:/tmp
    configs:
      - source: promtail-config
        target: /etc/promtail/promtail.yaml
    environment:
      # Grafana Cloud Loki Configuration
      LOKI_URL: ${LOKI_URL:-}
      LOKI_USERNAME: ${LOKI_USERNAME:-}
      LOKI_API_KEY: ${LOKI_API_KEY:-}
    networks:
      - observability-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9080/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# =============================================================================
# Configs - Embedded Configuration Files
# =============================================================================
configs:
  mimir-config:
    content: |
      multitenancy_enabled: false

      server:
        http_listen_port: 9009
        log_level: info

      distributor:
        ring:
          kvstore:
            store: memberlist

      ingester:
        ring:
          kvstore:
            store: memberlist
          replication_factor: 1

      blocks_storage:
        backend: filesystem
        filesystem:
          dir: /data/blocks
        bucket_store:
          sync_dir: /data/tsdb-sync

      compactor:
        data_dir: /data/compactor
        sharding_ring:
          kvstore:
            store: memberlist

      store_gateway:
        sharding_ring:
          replication_factor: 1

      ruler_storage:
        backend: filesystem
        filesystem:
          dir: /data/rules

      limits:
        max_global_series_per_user: 1500000
        ingestion_rate: 100000
        ingestion_burst_size: 200000

  prometheus-config:
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s

      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        - job_name: 'node-exporter'
          static_configs:
            - targets: ['node-exporter:9100']

        - job_name: 'mimir'
          static_configs:
            - targets: ['mimir:9009']

        - job_name: 'grafana'
          static_configs:
            - targets: ['grafana:3000']

      remote_write:
        - url: http://mimir:9009/api/v1/push
          send_exemplars: true

  promtail-config:
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: ${LOKI_URL:-http://localhost:3100/loki/api/v1/push}
          basic_auth:
            username: ${LOKI_USERNAME:-}
            password: ${LOKI_API_KEY:-}

      scrape_configs:
        - job_name: system
          static_configs:
            - targets:
                - localhost
              labels:
                job: varlogs
                __path__: /var/log/*log

        - job_name: containers
          static_configs:
            - targets:
                - localhost
              labels:
                job: containers
                __path__: /var/log/containers/*.log

# =============================================================================
# Volumes - Persistent Storage
# =============================================================================
volumes:
  grafana-data:
    driver: local
  influxdb-data:
    driver: local
  influxdb-config:
    driver: local
  mimir-data:
    driver: local
  prometheus-data:
    driver: local
  promtail-positions:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  observability-net:
    driver: bridge
  dokploy-network:
    external: true
