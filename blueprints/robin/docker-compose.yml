services:
  robin:
    image: apurvsg/robin:v2.0
    restart: always
    depends_on:
      tor:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      # ===========================================
      # Domain Configuration (Required)
      # ===========================================
      ROBIN_DOMAIN: ${DOMAIN:?Set your domain (e.g., robin.example.com)}
      ROBIN_URL: https://${DOMAIN}

      # ===========================================
      # Tor Configuration (Internal)
      # ===========================================
      TOR_PROXY_HOST: tor
      TOR_PROXY_PORT: "9050"

      # ===========================================
      # LLM Provider Configuration
      # Supported: venice, openrouter
      # Get tokens from:
      # - Venice.ai: https://venice.ai/console/api
      # - OpenRouter.ai: https://openrouter.ai/keys
      # ===========================================
      LLM_PROVIDER: ${LLM_PROVIDER:-venice}
      VENICE_API_KEY: ${VENICE_API_KEY:?Set Venice.ai API key from https://venice.ai/console/api}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # ===========================================
      # Cloudflare R2 Storage (Required)
      # Get from: Cloudflare Dashboard > R2 > Manage R2 API Tokens
      # Endpoint format: https://<ACCOUNT_ID>.r2.cloudflarestorage.com
      # ===========================================
      CF_ACCOUNT_ID: ${CF_ACCOUNT_ID:?Set Cloudflare Account ID}
      S3_ENDPOINT: https://${CF_ACCOUNT_ID:?Set CF_ACCOUNT_ID}.r2.cloudflarestorage.com
      S3_REGION: auto
      S3_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:?Set R2 access key ID from Cloudflare Dashboard}
      S3_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:?Set R2 secret access key from Cloudflare Dashboard}
      S3_BUCKET: ${R2_BUCKET_NAME:?Set R2 bucket name (e.g., robin-investigations)}
      S3_USE_PATH_STYLE: "true"
      S3_FORCE_PATH_STYLE: "false"

      # ===========================================
      # Streamlit Configuration
      # ===========================================
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_SERVER_PORT: "8501"
    networks:
      - robin-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.robin.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.robin.entrypoints=websecure"
      - "traefik.http.routers.robin.tls.certresolver=letsencrypt"
      - "traefik.http.services.robin.loadbalancer.server.port=8501"
      - "traefik.docker.network=dokploy-network"

  tor:
    image: osminogin/tor:latest  # Note: See README for recommended version pinning
    restart: always
    networks:
      - robin-net
    ports:
      - "127.0.0.1:9050:9050"
    expose:
      - "9050"
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "9050"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  robin-net:
    driver: bridge
  dokploy-network:
    external: true
