services:
  tor-relay:
    image: thetorproject/obfs4-bridge@sha256:c36577cdb0478b3a0123b132c82bfb560d4b88fdfbf317beeb65445551bd8182
    container_name: tor-relay
    restart: always
    volumes:
      - tor-data:/var/lib/tor
      - tor-keys:/var/lib/tor/keys
    environment:
      # Relay Configuration
      OR_PORT: ${OR_PORT:-9001}
      PT_PORT: ${PT_PORT:-}
      EMAIL: ${CONTACT_EMAIL:?Set contact email for relay operator}

      # Relay Type Configuration
      RELAY_TYPE: ${RELAY_TYPE:-middle}
      RELAY_NICKNAME: ${RELAY_NICKNAME:?Set relay nickname (alphanumeric, max 19 chars)}

      # Bandwidth Configuration
      RELAY_BANDWIDTH_RATE: ${RELAY_BANDWIDTH_RATE:-100} # KB/s
      RELAY_BANDWIDTH_BURST: ${RELAY_BANDWIDTH_BURST:-200} # KB/s

      # Optional: Traffic Accounting
      ACCOUNTING_MAX: ${ACCOUNTING_MAX:-}
      ACCOUNTING_START: ${ACCOUNTING_START:-}

      # Optional: MyFamily (comma-separated fingerprints)
      MY_FAMILY: ${MY_FAMILY:-}

      # Advanced Configuration
      OBFS4_ENABLE_ADDITIONAL_VARIABLES: ${ENABLE_ADVANCED_CONFIG:-0}
    ports:
      - "${OR_PORT:-9001}:${OR_PORT:-9001}"
      - "${PT_PORT:-9002}:${PT_PORT:-9002}"
    networks:
      - tor-net
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/tor/tor.sock || nc -z localhost ${OR_PORT:-9001}"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  tor-data:
    driver: local
  tor-keys:
    driver: local

networks:
  tor-net:
    driver: bridge
