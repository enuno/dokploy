services:
  # =============================================================================
  # Open Notebook - Private Multi-Model AI Knowledge Management Platform
  # Local alternative to NotebookLM with full privacy and control
  # =============================================================================
  open-notebook:
    image: lfnovo/open_notebook:v1-latest-single
    restart: always
    volumes:
      # Persist user notebooks and research data
      - open-notebook-data:/app/data
      # Persist SurrealDB embedded database
      - open-notebook-db:/mydata
    environment:
      # =======================================================================
      # API Configuration
      # =======================================================================
      API_URL: https://${OPEN_NOTEBOOK_DOMAIN}:5055
      INTERNAL_API_URL: http://localhost:5055

      # =======================================================================
      # Database Configuration (SurrealDB Embedded)
      # =======================================================================
      SURREAL_URL: ws://localhost:8000/rpc
      SURREAL_USER: ${SURREAL_USER:-root}
      SURREAL_PASSWORD: ${SURREAL_PASSWORD:?Set SurrealDB password}
      SURREAL_NAMESPACE: ${SURREAL_NAMESPACE:-open_notebook}
      SURREAL_DATABASE: ${SURREAL_DATABASE:-production}

      # =======================================================================
      # Security (Optional - Recommended for Public Hosting)
      # =======================================================================
      OPEN_NOTEBOOK_PASSWORD: ${OPEN_NOTEBOOK_PASSWORD:-}

      # =======================================================================
      # AI Provider Configuration (At Least One Required)
      # =======================================================================
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # Anthropic Claude
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # Local Ollama
      OLLAMA_API_BASE: ${OLLAMA_API_BASE:-}

      # Google Gemini
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # Mistral
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}

      # DeepSeek
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}

      # =======================================================================
      # Optional Features
      # =======================================================================
      # ElevenLabs TTS (for podcast generation)
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}

      # Web Crawling
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-}
      JINA_API_KEY: ${JINA_API_KEY:-}

      # Voyage AI Embeddings
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}

      # =======================================================================
      # Application Settings
      # =======================================================================
      API_CLIENT_TIMEOUT: ${API_CLIENT_TIMEOUT:-300}
      ESPERANTO_LLM_TIMEOUT: ${ESPERANTO_LLM_TIMEOUT:-60}
      TTS_BATCH_SIZE: ${TTS_BATCH_SIZE:-5}

      # =======================================================================
      # Container User (Optional)
      # =======================================================================
      UID: ${UID:-1000}
      GID: ${GID:-1000}

    networks:
      - open-notebook-network
      - dokploy-network
    labels:
      # =======================================================================
      # Traefik Routing Configuration
      # =======================================================================
      - "traefik.enable=true"
      - "traefik.http.routers.open-notebook.rule=Host(`${OPEN_NOTEBOOK_DOMAIN}`)"
      - "traefik.http.routers.open-notebook.entrypoints=websecure"
      - "traefik.http.routers.open-notebook.tls.certresolver=letsencrypt"

      # Security headers middleware
      - "traefik.http.routers.open-notebook.middlewares=open-notebook-security-headers@docker"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.open-notebook-security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"

      # Service configuration
      - "traefik.http.services.open-notebook.loadbalancer.server.port=8502"
      - "traefik.docker.network=dokploy-network"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8502"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Next.js + FastAPI + embedded SurrealDB startup time

# =============================================================================
# Volumes
# =============================================================================
volumes:
  open-notebook-data:
    driver: local
  open-notebook-db:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  open-notebook-network:
    driver: bridge
  dokploy-network:
    external: true
