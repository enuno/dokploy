services:
  # =============================================================================
  # Chibisafe Backend - API Server
  # =============================================================================
  backend:
    image: chibisafe/chibisafe-server:v6.5.5
    restart: always
    volumes:
      # File-based database storage
      - chibisafe-database:/app/database
      # User uploaded files
      - chibisafe-uploads:/app/uploads
      # Application logs
      - chibisafe-logs:/app/logs
    environment:
      # =======================================================================
      # Server Configuration
      # =======================================================================
      # Base URL for the application
      BASE_URL: https://${CHIBISAFE_DOMAIN}

      # Service URL (internal communication)
      SERVICE_URL: http://backend:8000

      # =======================================================================
      # Storage Configuration
      # =======================================================================
      # Database path (file-based SQLite)
      DATABASE_PATH: /app/database/chibisafe.db

      # Upload storage path
      UPLOAD_PATH: /app/uploads

      # Maximum upload file size
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-100MB}

      # =======================================================================
      # Admin User (Created on First Run)
      # IMPORTANT: Change password immediately after first login!
      # =======================================================================
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?Set admin password (CHANGE AFTER FIRST LOGIN)}

      # =======================================================================
      # External Storage - Cloudflare R2 (Optional)
      # Enable S3-compatible storage for scalable file uploads
      # Get credentials from: Cloudflare Dashboard > R2 > Manage R2 API Tokens
      # Endpoint format: https://<ACCOUNT_ID>.r2.cloudflarestorage.com
      # =======================================================================
      S3_ENABLED: ${S3_ENABLED:-false}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_REGION: ${S3_REGION:-auto}
      S3_PATH_STYLE: ${S3_PATH_STYLE:-true}
    networks:
      - chibisafe-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M

  # =============================================================================
  # Chibisafe Frontend - Web UI
  # =============================================================================
  frontend:
    image: chibisafe/chibisafe:v6.5.5
    restart: always
    environment:
      # =======================================================================
      # Frontend Configuration
      # =======================================================================
      # Backend API URL (internal communication)
      API_URL: http://backend:8000

      # Public base URL (accessible via Traefik)
      BASE_URL: https://${CHIBISAFE_DOMAIN}
    networks:
      - chibisafe-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M

  # =============================================================================
  # Caddy - Reverse Proxy (Merges Frontend + Backend)
  # =============================================================================
  caddy:
    image: caddy:2-alpine
    restart: always
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
    volumes:
      - caddy-data:/data
      - caddy-config:/config
      # Mount Caddyfile from template directory
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      - chibisafe-net      # Internal communication
      - dokploy-network    # External access via Traefik
    labels:
      # Traefik routing labels
      - "traefik.enable=true"
      - "traefik.http.routers.chibisafe.rule=Host(`${CHIBISAFE_DOMAIN}`)"
      - "traefik.http.routers.chibisafe.entrypoints=websecure"
      - "traefik.http.routers.chibisafe.tls.certresolver=letsencrypt"
      - "traefik.http.routers.chibisafe.middlewares=chibisafe-security@docker"

      # Security headers middleware (defense-in-depth)
      - "traefik.http.middlewares.chibisafe-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.chibisafe-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.chibisafe-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.chibisafe-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.chibisafe-security.headers.referrerPolicy=strict-origin-when-cross-origin"

      # Service configuration
      - "traefik.http.services.chibisafe.loadbalancer.server.port=80"
      - "traefik.docker.network=dokploy-network"
    command:
      - "caddy"
      - "run"
      - "--config"
      - "/etc/caddy/Caddyfile"
      - "--adapter"
      - "caddyfile"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  chibisafe-database:
    driver: local
  chibisafe-uploads:
    driver: local
  chibisafe-logs:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  chibisafe-net:
    driver: bridge
  dokploy-network:
    external: true
